<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juatuba - Ministrando com Amor</title>
    <style>
        :root { 
            --primaria: #1e40af; 
            --gradiente: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            --sucesso: #059669; 
            --fundo: #f1f5f9; 
            --perigo: #dc2626;
            --texto: #1e293b;
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--fundo); margin: 0; padding: 15px; color: var(--texto); }

        .header { 
            background: var(--gradiente); 
            color: white; padding: 35px 20px; text-align: center; 
            border-radius: 0 0 30px 30px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        .header h1 { margin: 0; font-size: 1.6rem; font-weight: 800; }
        .ovelha-box { 
            display: inline-flex; align-items: center; gap: 8px; margin-top: 12px; 
            font-size: 0.9rem; background: rgba(255,255,255,0.2);
            padding: 8px 18px; border-radius: 50px; font-weight: 500;
        }

        .container { max-width: 500px; margin: 0 auto; }
        .card { 
            background: white; border-radius: 20px; padding: 22px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .card-title { 
            display: flex; align-items: center; gap: 8px; font-weight: 700; 
            color: #64748b; margin-bottom: 15px; font-size: 0.75rem; text-transform: uppercase;
        }

        select, textarea, input[type="date"] { 
            width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #e2e8f0; 
            background: #fff; font-size: 1rem; outline: none; box-sizing: border-box;
        }

        .grid-acoes { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn { border: none; border-radius: 12px; padding: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; }
        
        .btn-p { background: #ecfdf5; color: #065f46; }
        .btn-m { background: var(--primaria); color: white; }
        .btn-f { background: #fef2f2; color: #991b1b; grid-column: span 2; }
        .btn-undo { background: #f8fafc; color: #94a3b8; grid-column: span 2; font-size: 0.7rem; }

        .dash-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: #fff; border-radius: 12px; margin-bottom: 8px;
            border: 1px solid #fee2e2; border-left: 5px solid var(--perigo);
        }
        .alerta-faltas { background: var(--perigo); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; }

        .barra-bg { background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden; margin: 12px 0; }
        .barra-fill { background: var(--sucesso); height: 100%; width: 0%; transition: 1s ease; }
    </style>
</head>
<body>

<div class="header">
    <h1>Ramo Juatuba ‚õ™</h1>
    <div class="ovelha-box">üêë Ministrando com Amor</div>
</div>

<div class="container">
    <div id="setup" class="card">
        <div class="card-title">‚ú® Configura√ß√£o Inicial</div>
        <textarea id="dadosIn" rows="3" placeholder="Cole aqui: Nome | Telefone | Idade | G√™nero"></textarea>
        <button class="btn btn-m" style="width:100%; margin-top:15px;" onclick="importar()">CONSTRUIR LISTA üöÄ</button>
    </div>

    <div id="app" style="display:none;">
        <div class="card">
            <div class="card-title">üìÖ Registro de Domingo</div>
            <input type="date" id="dataAtual" onchange="render()">
            <div class="barra-bg"><div id="barra" class="barra-fill"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:700;">
                <span style="color:#64748b">MINISTRANDO COM AMOR</span>
                <span id="txtProg" style="color:var(--sucesso)">0/0</span>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üë§ Selecionar Membro</div>
            <select id="filtroOrg" onchange="render()">
                <option value="Todos">üë• Todos</option>
                <option value="Sociedade">üå∏ Sociedade</option>
                <option value="Qu√≥rum">üëî Qu√≥rum</option>
                <option value="ORM">üéí Jovens</option>
                <option value="Prim√°ria">üß∏ Prim√°ria</option>
            </select>
            <div style="margin-top:10px;"></div>
            <select id="lista" onchange="selecionar()"></select>

            <div id="foco" style="display:none; text-align:center; padding-top:20px;">
                <span id="nomeFoco" style="font-size:1.2rem; font-weight:800; color:var(--primaria);"></span><br>
                <div class="grid-acoes">
                    <button class="btn btn-p" onclick="registrar('P_SIL')">PRESEN√áA SILENCIOSA</button>
                    <button class="btn btn-m" onclick="registrar('MSG_P')">üìñ CELEBRAR</button>
                    <button class="btn btn-f" onclick="registrar('FAL')">‚ù§Ô∏è RESGATAR COM AMOR</button>
                    <button id="btnUndo" class="btn btn-undo" onclick="desfazer()">‚Ü©Ô∏è CORRIGIR ERRO</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìä Mural de Aten√ß√£o (2+ Faltas)</div>
            <div id="dashLista"></div>
            <button class="btn btn-m" style="width:100%; margin-top:20px; background: #64748b;" onclick="exportarCSV()">üì• EXPORTAR HIST√ìRICO</button>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('juatuba_db')) || [];
    let hTotal = JSON.parse(localStorage.getItem('juatuba_hist_total')) || [];
    document.getElementById('dataAtual').value = new Date().toISOString().split('T')[0];
    const icons = { "Sociedade": "üå∏", "Qu√≥rum": "üëî", "ORM": "üéí", "Prim√°ria": "üß∏" };

    // MENSAGENS FUNDAMENTADAS NO "N√ìS"
    const msgsR = [
        "Ol√°! N√≥s sentimos muito sua falta hoje. Lembramos que em Mosias 18:21, fomos ensinados a ter 'nossos cora√ß√µes entrela√ßados em unidade'. Saiba que n√≥s valorizamos sua presen√ßa e que sua aus√™ncia deixa um vazio em nosso c√≠rculo de amizade. Desejamos que as b√™n√ß√£os do c√©u acompanhem sua semana! ‚ù§Ô∏è",
        "Como voc√™ est√°? N√≥s sentimos que nossa reuni√£o n√£o foi a mesma sem voc√™. Em D&C 38:27, o Senhor pede para sermos um, e n√≥s realmente sentimos falta da sua parte nessa uni√£o. Saiba que n√≥s nos importamos e que voc√™ est√° em nossas ora√ß√µes e pensamentos. Esperamos te ver em breve! ü´Ç",
        "N√≥s sentimos sua falta hoje e lembramos que 'o valor das almas √© grande √† vista de Deus' (D&C 18:10). N√≥s reconhecemos a luz especial que voc√™ traz e nossa adora√ß√£o parece incompleta sem sua companhia. Que o conforto do Esp√≠rito esteja com voc√™ e sua fam√≠lia nesta semana. ‚ú®",
        "N√≥s sentimos falta da sua companhia preciosa. Paulo ensinou em 1 Cor√≠ntios 12 que todos n√≥s somos necess√°rios para que o corpo de Cristo seja perfeito. N√≥s realmente sentimos que faltou uma parte importante hoje. Que o amor do Salvador te envolva at√© estarmos juntos novamente! üåü"
    ];

    const msgsC = [
        "N√≥s nos alegramos muito com sua presen√ßa hoje! Como diz o Salmo 122:1, n√≥s ficamos felizes em ir juntos √† casa do Senhor. Obrigado por fortalecer nossa f√© com seu esp√≠rito. Uma semana aben√ßoada! ‚ù§Ô∏è"
    ];

    if(db.length > 0) { document.getElementById('setup').style.display='none'; document.getElementById('app').style.display='block'; render(); }

    function importar() {
        const txt = document.getElementById('dadosIn').value.trim();
        db = txt.split('\n').map(l => {
            const c = l.split(/\t/);
            const idade = parseInt(c[2]) || 0;
            const gen = c[3]?.trim().toUpperCase();
            let org = (idade >= 18) ? (gen === 'M' ? "Sociedade" : "Qu√≥rum") : (idade >= 12 ? "ORM" : "Prim√°ria");
            return { nome: c[0], tel: c[1]?.replace(/\D/g,''), org };
        }).filter(m => m.nome);
        localStorage.setItem('juatuba_db', JSON.stringify(db));
        location.reload();
    }

    function render() {
        const filtro = document.getElementById('filtroOrg').value;
        const sel = document.getElementById('lista');
        const dataSel = document.getElementById('dataAtual').value;
        sel.innerHTML = '<option value="">Quem buscaremos?</option>';
        const pHoje = hTotal.filter(h => h.data === dataSel);
        
        db.filter(m => filtro === 'Todos' || m.org === filtro).sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(m => {
            const mar = pHoje.find(h => h.nome === m.nome);
            const opt = document.createElement('option');
            opt.value = db.indexOf(m);
            opt.textContent = (mar ? (mar.status === 'PRESENTE' ? "‚úÖ " : "‚ùå ") : "") + icons[m.org] + " " + m.nome;
            sel.appendChild(opt);
        });

        const perc = (pHoje.filter(x=>x.status==='PRESENTE').length / db.length * 100) || 0;
        document.getElementById('barra').style.width = perc + "%";
        document.getElementById('txtProg').textContent = `${pHoje.filter(x=>x.status==='PRESENTE').length}/${db.length}`;
        atualizarDashboard();
    }

    function selecionar() {
        const i = document.getElementById('lista').value;
        if(i!=="") { 
            const m = db[i];
            document.getElementById('nomeFoco').textContent = icons[m.org] + " " + m.nome; 
            document.getElementById('foco').style.display='block'; 
            const mar = hTotal.find(h => h.nome === m.nome && h.data === document.getElementById('dataAtual').value);
            document.getElementById('btnUndo').style.display = mar ? 'flex' : 'none';
        } else { document.getElementById('foco').style.display='none'; }
    }

    function registrar(tp) {
        const dataSel = document.getElementById('dataAtual').value;
        const m = db[document.getElementById('lista').value];
        hTotal = hTotal.filter(h => !(h.nome === m.nome && h.data === dataSel));
        hTotal.push({ nome: m.nome, data: dataSel, status: (tp === 'FAL' ? 'FALTANTE' : 'PRESENTE'), org: m.org });
        
        if(tp !== 'P_SIL') {
            let msg = (tp === 'MSG_P') ? msgsC[Math.floor(Math.random()*msgsC.length)] : msgsR[Math.floor(Math.random()*msgsR.length)];
            window.open(`https://wa.me/${m.tel}?text=${encodeURIComponent(msg)}`);
        }
        localStorage.setItem('juatuba_hist_total', JSON.stringify(hTotal));
        render(); selecionar();
    }

    function atualizarDashboard() {
        const cont = document.getElementById('dashLista');
        cont.innerHTML = "";
        let contagem = {};
        hTotal.filter(h => h.status === 'FALTANTE').forEach(h => { contagem[h.nome] = (contagem[h.nome] || 0) + 1; });
        const cr√≠ticos = Object.entries(contagem).filter(([n, f]) => f >= 2).sort((a,b) => b[1] - a[1]);

        if(cr√≠ticos.length === 0) {
            cont.innerHTML = "<p style='font-size:0.8rem; color:#94a3b8; text-align:center;'>Nenhuma ovelha com faltas recorrentes. ‚ù§Ô∏è</p>";
            return;
        }

        cr√≠ticos.forEach(([nome, faltas]) => {
            const m = db.find(x => x.nome === nome);
            const d = document.createElement('div');
            d.className = 'dash-item';
            d.innerHTML = `<div><span style="font-size:0.9rem; font-weight:700;">${icons[m?.org || 'Sociedade']} ${nome}</span></div><div style="display:flex; align-items:center; gap:10px;"><span class="alerta-faltas">${faltas} FALTAS</span><button style="border:none; background:#22c55e; color:white; padding:8px; border-radius:8px; cursor:pointer;" onclick="enviarNovamente('${nome}')">üì±</button></div>`;
            cont.appendChild(d);
        });
    }

    function enviarNovamente(nome) {
        const m = db.find(x => x.nome === nome);
        const msg = msgsR[Math.floor(Math.random()*msgsR.length)];
        window.open(`https://wa.me/${m.tel}?text=${encodeURIComponent(msg)}`);
    }

    function exportarCSV() {
        let csv = "\uFEFFNome;Data;Status;Organizacao\n";
        hTotal.forEach(h => { csv += `${h.nome};${h.data};${h.status};${h.org}\n`; });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Ministracao_Juatuba.csv`;
        link.click();
    }

    function desfazer() {
        hTotal = hTotal.filter(h => !(h.nome === db[document.getElementById('lista').value].nome && h.data === document.getElementById('dataAtual').value));
        localStorage.setItem('juatuba_hist_total', JSON.stringify(hTotal));
        render(); selecionar();
    }
</script>
</body>
</html>