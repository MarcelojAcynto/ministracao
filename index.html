<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministra√ß√£o com Amor - Ramo Juatuba</title>
    <style>
        /* CSS Unificado - Foco na Clareza e Simplicidade */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; color: #333; }
        header { background-color: #2c3e50; color: #fff; padding: 1.5em; text-align: center; }
        header nav ul { list-style: none; margin: 10px 0 0; padding: 0; display: flex; justify-content: center; gap: 20px; }
        header nav a { color: #fff; text-decoration: none; font-size: 0.8rem; opacity: 0.8; }
        
        main { display: flex; flex-direction: column; align-items: center; padding: 2em; }
        .hero { text-align: center; margin-bottom: 20px; }
        .hero h2 { color: #2c3e50; margin-bottom: 5px; }
        .hero p { font-style: italic; color: #7f8c8d; }

        .card { 
            background: white; border-radius: 15px; padding: 25px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            width: 100%; max-width: 500px; box-sizing: border-box;
        }

        .card-title { font-weight: bold; color: #95a5a6; margin-bottom: 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }

        select, textarea, input[type="date"] { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #dcdde1; 
            font-size: 1rem; outline: none; box-sizing: border-box;
        }

        .grid-acoes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { border: none; border-radius: 8px; padding: 15px; font-weight: bold; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .btn-p { background: #e8f5e9; color: #2e7d32; }
        .btn-m { background: #2c3e50; color: white; }
        .btn-f { background: #fff1f0; color: #cf1322; grid-column: span 2; }
        .btn-undo { background: #f5f6fa; color: #7f8c8d; width: 100%; margin-top: 10px; }
        
        .dash-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 8px;
            border-left: 5px solid #cf1322; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .alerta-faltas { background: #cf1322; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; }
        .barra-bg { background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden; margin: 15px 0; }
        .barra-fill { background: #27ae60; height: 100%; width: 0%; transition: 0.5s; }
        
        footer { background: #2c3e50; color: white; padding: 1em; text-align: center; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <h1>Ministra√ß√£o Crist√£</h1>
    <nav>
        <ul>
            <li><a href="#" onclick="abrirSetup()">‚öôÔ∏è ATUALIZAR LISTA</a></li>
            <li><a href="#" onclick="exportarCSV()">üì• EXPORTAR DADOS</a></li>
        </ul>
    </nav>
</header>

<main>
    <section class="hero">
        <h2>"Apascenta as minhas ovelhas"</h2>
        <p>Jo√£o 21:17</p>
    </section>

    <div id="setup" class="card">
        <div class="card-title">Configura√ß√£o da Lista</div>
        <textarea id="dadosIn" rows="5" placeholder="Cole aqui os dados da planilha (Nome | Telefone | Idade | G√™nero)"></textarea>
        <button class="btn btn-m" style="width:100%; margin-top:10px;" onclick="importar()">CONSTRUIR LISTA üöÄ</button>
    </div>

    <div id="app" style="display:none; width: 100%; max-width: 500px;">
        <div class="card">
            <div class="card-title">Frequ√™ncia Dominical</div>
            <input type="date" id="dataAtual" onchange="render()">
            <div class="barra-bg"><div id="barra" class="barra-fill"></div></div>
            <div style="text-align: right; font-size: 0.8rem; font-weight: bold; color: #27ae60;" id="txtProg">0/0</div>
        </div>

        <div class="card">
            <div class="card-title">Membro em Foco</div>
            <select id="filtroOrg" onchange="render()" style="margin-bottom: 10px;">
                <option value="Todos">üë• Todas as Organiza√ß√µes</option>
                <option value="Sociedade">üå∏ Sociedade de Socorro</option>
                <option value="Qu√≥rum">üëî Qu√≥rum de √âlderes</option>
                <option value="ORM">üéí Jovens (Mo√ßas e Rapazes)</option>
                <option value="Prim√°ria">üß∏ Prim√°ria</option>
            </select>
            <select id="lista" onchange="selecionar()"></select>

            <div id="foco" style="display:none; text-align:center; padding-top:20px;">
                <span id="nomeFoco" style="font-size:1.3rem; font-weight:bold; color:#2c3e50;"></span>
                <div class="grid-acoes">
                    <button class="btn btn-p" onclick="registrar('P_SIL')">REGISTRAR PRESEN√áA</button>
                    <button class="btn btn-m" onclick="registrar('MSG_P')">üìñ SAUDA√á√ÉO CRIST√É</button>
                    <button class="btn btn-f" onclick="registrar('FAL')">‚ù§Ô∏è RESGATAR COM AMOR</button>
                    <button id="btnUndo" class="btn btn-undo" onclick="desfazer()">‚Ü©Ô∏è CORRIGIR REGISTRO</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìä Mural de Cuidado (2+ Faltas)</div>
            <div id="dashLista"></div>
        </div>
    </div>
</main>

<footer>
    <p>"Por meio do amor, servi-vos uns aos outros." ‚Äî G√°latas 5:13</p>
</footer>

<script>
    let db = JSON.parse(localStorage.getItem('juatuba_db')) || [];
    let hTotal = JSON.parse(localStorage.getItem('juatuba_hist_total')) || [];
    document.getElementById('dataAtual').value = new Date().toISOString().split('T')[0];
    
    const icons = { "Sociedade": "üå∏", "Qu√≥rum": "üëî", "ORM": "üéí", "Prim√°ria": "üß∏" };

    const gerarMsgResgate = (nome) => {
        const mensagens = [
            `Ol√°, Irm√£o(√£) ${nome}! ‚ú®%0A%0AN√≥s sentimos muito sua falta hoje. Ao olharmos para o lado, sentimos que faltava uma parte especial de nossa fam√≠lia. %0A%0AComo ensinou o √âlder Uchtdorf: "Deus n√£o nos olha com etiquetas, Ele nos olha com amor". N√≥s sentimos esse mesmo amor por voc√™ e queremos que saiba que sua presen√ßa √© luz em nosso meio. %0A%0AQue o conforto do Salvador visite seu cora√ß√£o hoje! ‚ù§Ô∏è`,
            
            `Ol√°, nosso(a) querido(a) Irm√£o(√£) ${nome}! üïäÔ∏è%0A%0AComo voc√™ est√°? Pensamos muito em voc√™ hoje durante as reuni√µes. %0A%0AAlma ensinou em Mor√¥ni 6:4 que a Igreja se reunia frequentemente para "falar sobre o bem-estar de suas almas". N√≥s realmente nos preocupamos com o seu bem-estar e sentimos falta de ouvir sua voz e sentir seu esp√≠rito conosco. %0A%0ASaiba que n√≥s estamos aqui para o que precisar. Receba nosso abra√ßo sincero! ü´Ç`,
            
            `Ol√°, Irm√£o(√£) ${nome}! üåø%0A%0AN√≥s sentimos sua falta! Em nossas reuni√µes hoje, lembramos do convite de Cristo: "Vinde a mim". %0A%0AN√≥s sabemos que a jornada da vida tem seus desafios, e queremos que saiba que voc√™ n√£o precisa caminhar s√≥. Como membros do corpo de Cristo (1 Cor√≠ntios 12), n√≥s precisamos de voc√™ para estarmos completos. %0A%0AQue sua semana seja repleta da paz que s√≥ o Senhor pode dar. Estamos ansiosos para te ver! üåü`,
            
            `Oi, Irm√£o(√£) ${nome}! ‚ù§Ô∏è%0A%0AEstou te escrevendo porque n√≥s sentimos um vazio em nossa classe hoje sem voc√™. %0A%0AO Presidente Nelson nos lembrou que "cada um de n√≥s √© precioso para Deus". N√≥s sentimos exatamente isso em rela√ß√£o a voc√™. %0A%0ANossa ora√ß√£o √© para que voc√™ sinta o calor do amor do Pai Celestial em cada pequeno detalhe do seu dia. Voc√™ faz muita falta! üêë`
        ];
        return mensagens[Math.floor(Math.random() * mensagens.length)];
    };

    const gerarMsgPresenca = (nome) => `Ol√°, nosso(a) querido(a) Irm√£o(√£) ${nome}! ‚ù§Ô∏è%0A%0AN√≥s ficamos t√£o felizes em ver voc√™ hoje! Sua presen√ßa traz uma paz especial para nossas reuni√µes. %0A%0AObrigado por compartilhar sua luz conosco, cumprindo o que o Salvador pediu: "Assim brilhe a vossa luz diante dos homens" (Mateus 5:16). %0A%0AUma semana maravilhosa e aben√ßoada para voc√™! üôè`;

    function abrirSetup() { document.getElementById('setup').style.display='block'; document.getElementById('app').style.display='none'; }
    if(db.length > 0) { document.getElementById('setup').style.display='none'; document.getElementById('app').style.display='block'; render(); }

    function importar() {
        const txt = document.getElementById('dadosIn').value.trim();
        if(!txt) return;
        db = txt.split('\n').map(l => {
            const c = l.split(/\t/);
            const idade = parseInt(c[2]) || 0;
            const gen = c[3]?.trim().toUpperCase();
            let org = (idade >= 18) ? (gen === 'M' ? "Sociedade" : "Qu√≥rum") : (idade >= 12 ? "ORM" : "Prim√°ria");
            return { nome: c[0].trim(), tel: c[1]?.replace(/\D/g,''), org };
        }).filter(m => m.nome);
        localStorage.setItem('juatuba_db', JSON.stringify(db));
        location.reload();
    }

    function render() {
        const filtro = document.getElementById('filtroOrg').value;
        const sel = document.getElementById('lista');
        const dataSel = document.getElementById('dataAtual').value;
        sel.innerHTML = '<option value="">Selecione um membro...</option>';
        const pHoje = hTotal.filter(h => h.data === dataSel);
        
        db.filter(m => filtro === 'Todos' || m.org === filtro).sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(m => {
            const mar = pHoje.find(h => h.nome === m.nome);
            const statusIcon = mar ? (mar.status === 'PRESENTE' ? "‚úÖ " : "‚ùå ") : "";
            const orgIcon = icons[m.org] || "üë§";
            
            const opt = document.createElement('option');
            opt.value = db.indexOf(m);
            opt.textContent = `${statusIcon}${orgIcon} ${m.nome}`;
            sel.appendChild(opt);
        });

        const pCount = pHoje.filter(x=>x.status==='PRESENTE').length;
        document.getElementById('barra').style.width = (pCount / db.length * 100 || 0) + "%";
        document.getElementById('txtProg').textContent = `${pCount}/${db.length} Presentes`;
        atualizarDashboard();
    }

    function selecionar() {
        const i = document.getElementById('lista').value;
        if(i!=="") { 
            const m = db[i];
            const orgIcon = icons[m.org] || "üë§";
            document.getElementById('nomeFoco').textContent = `${orgIcon} ${m.nome}`; 
            document.getElementById('foco').style.display='block'; 
            const mar = hTotal.find(h => h.nome === m.nome && h.data === document.getElementById('dataAtual').value);
            document.getElementById('btnUndo').style.display = mar ? 'block' : 'none';
        } else { document.getElementById('foco').style.display='none'; }
    }

    function registrar(tp) {
        const dataSel = document.getElementById('dataAtual').value;
        const m = db[document.getElementById('lista').value];
        hTotal = hTotal.filter(h => !(h.nome === m.nome && h.data === dataSel));
        hTotal.push({ nome: m.nome, data: dataSel, status: (tp === 'FAL' ? 'FALTANTE' : 'PRESENTE'), org: m.org });
        
        if(tp !== 'P_SIL') {
            const msg = (tp === 'MSG_P') ? gerarMsgPresenca(m.nome) : gerarMsgResgate(m.nome);
            window.open(`https://wa.me/${m.tel}?text=${msg}`);
        }
        localStorage.setItem('juatuba_hist_total', JSON.stringify(hTotal));
        render(); selecionar();
    }

    function atualizarDashboard() {
        const cont = document.getElementById('dashLista');
        cont.innerHTML = "";
        let contagem = {};
        hTotal.filter(h => h.status === 'FALTANTE').forEach(h => { contagem[h.nome] = (contagem[h.nome] || 0) + 1; });
        const cr√≠ticos = Object.entries(contagem).filter(([n, f]) => f >= 2).sort((a,b) => b[1] - a[1]);

        if(cr√≠ticos.length === 0) {
            cont.innerHTML = "<p style='font-size:0.8rem; color:#95a5a6; text-align:center;'>Todas as ovelhas est√£o no redil. ‚ù§Ô∏è</p>";
            return;
        }

        cr√≠ticos.forEach(([nome, faltas]) => {
            const m = db.find(x => x.nome === nome);
            const orgIcon = icons[m?.org] || "üë§";
            const d = document.createElement('div');
            d.className = 'dash-item';
            d.innerHTML = `<span style="font-weight:bold;">${orgIcon} ${nome}</span> <div><span class="alerta-faltas">${faltas} Faltas</span></div>`;
            cont.appendChild(d);
        });
    }

    function exportarCSV() {
        let csv = "\uFEFFNome;Data;Status;Organizacao\n";
        hTotal.forEach(h => { csv += `${h.nome};${h.data};${h.status};${h.org}\n`; });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Ministracao_Juatuba.csv`;
        link.click();
    }

    function desfazer() {
        const index = document.getElementById('lista').value;
        hTotal = hTotal.filter(h => !(h.nome === db[index].nome && h.data === document.getElementById('dataAtual').value));
        localStorage.setItem('juatuba_hist_total', JSON.stringify(hTotal));
        render(); selecionar();
    }
</script>
</body>
</html>